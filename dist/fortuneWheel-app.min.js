let fortuneWheels=[],spunBoxes=[],selectedFortuneWheel=null;async function fetchWheelData(){const e=extractAuthDataFromCookie(),n=await fetchGraphQL("\n    query GetUserBoxes($userId: ID, $brandId: ID!) {\n      userBoxConnection(userId: $userId, brandId: $brandId, status: ACTIVE) {\n        edges {\n          node {\n            box {\n              id\n              type\n              rewards {\n                action {\n                  ... on GiveAndActivateBonusAction {\n                    bonusId\n                    bonus {\n                      description\n                      contentId\n                    }\n                  }\n                  ... on GiveBonusAction {\n                    bonusId\n                    bonus {\n                      description\n                      contentId\n                    }\n                  }\n                  ... on GiveBoxAction {\n                    boxId\n                    box {\n                      description\n                      contentId\n                    }\n                  }\n                }\n                probability\n              }\n            }\n            status\n            userBoxId\n          }\n        }\n      }\n    }\n  ",{userId:e.userId,brandId:BRAND_ID});if(fortuneWheels=n.data.userBoxConnection.edges.map((e=>e.node)).filter((e=>"ACTIVE"===e.status&&"WHEEL_OF_FORTUNE"===e.box.type&&!spunBoxes.includes(e.userBoxId))),0===fortuneWheels.length){const e=document.createElement("div");return e.id="noActiveWheelsMessage",e.textContent="",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="10px 20px",e.style.backgroundColor="#f8d7da",e.style.color="#721c24",e.style.border="1px solid #f5c6cb",e.style.borderRadius="5px",document.body.appendChild(e),void setTimeout((()=>{document.body.removeChild(e)}),3e3)}displayFortuneWheels()}function displayFortuneWheels(){document.getElementById("fortuneListTop").innerHTML='<span class="choose-wheel-text"></span>';const e=document.getElementById("fortuneList");e.innerHTML="",fortuneWheels.forEach(((n,t)=>{const o=document.createElement("button");o.textContent=`${t+1}`,o.style.margin="5px",o.onclick=()=>{selectFortuneWheel(n,t),resetRotation()},o.id=`wheel-btn-${t}`,e.appendChild(o)}))}function resetRotation(){const e=document.getElementById("wheel");e&&(e.style.transform="rotate(0deg)",e.style.transition="none")}function selectFortuneWheel(e,n){selectedFortuneWheel=e,selectedFortuneWheel.index=n,renderFortuneWheel(selectedFortuneWheel.box.rewards),document.getElementById("spinWheelButton").disabled=!1}function renderFortuneWheel(e){const n=document.getElementById("wheel");n.innerHTML="";const t=e.length;e.forEach(((e,o)=>{const s=document.createElement("div");s.className="segment";const r=-360/t*o,d=r+160,a=r+52;s.style.setProperty("--rot-var",`rotate(${r}deg)`),s.style.setProperty("--rot-var-random",`rotate(${d}deg)`),s.style.setProperty("--rot-var-random-two",`rotate(${a}deg)`);const l=e.action[0].bonus?.contentId?`var(--${e.action[0].bonus.contentId})`:`var(--${e.action[0].box.contentId})`;s.style.setProperty("--background-image-var",l),s.style.transform=`rotate(${360/t*o}deg)`,s.dataset.index=o,s.innerHTML='<span class="wheel-reward-holder"><br></span>';const i=s.querySelector(".wheel-reward-holder");i?i.style.setProperty("background-image",`${l}, radial-gradient(rgba(255, 255, 255, .2), rgba(0, 0, 0, 0))`):console.warn("wheel-reward-holder not found inside segment."),n.appendChild(s)}))}async function openFortuneBox(e){const n={input:{userBoxId:e}},t=await fetchGraphQL("\n    mutation OpenUserBox($input: OpenUserBoxInput!) {\n      openUserBox(input: $input) {\n        userBox {\n          reward {\n            action {\n              ... on GiveBonusAction {\n                bonusId\n              }\n              ... on GiveAndActivateBonusAction {\n                bonusId\n              }\n              ... on GiveBoxAction {\n                boxId\n              }\n            }\n          }\n        }\n      }\n    }\n  ",n);if(!t||!t.data||!t.data.openUserBox)throw new Error("Failed to open user box or invalid response structure.");return t.data.openUserBox.userBox.reward.action.map((e=>e.bonusId||e.boxId))}async function startWheelSpin(){if(!selectedFortuneWheel)return void alert("No wheel selected. Please select a fortune wheel first.");const e=document.getElementById("spinWheelButton");e.disabled=!0;const n=document.getElementById("wheel");try{playSound("spinStartSound");const t=await openFortuneBox(selectedFortuneWheel.userBoxId),o=selectedFortuneWheel.box.rewards.findIndex((e=>{const n=e.action[0],o=n.bonusId||n.boxId;return t.includes(o)}));if(-1===o)return console.error("No matching reward found for the awarded actions:",t),void(e.disabled=!1);const s=1800-360/selectedFortuneWheel.box.rewards.length*o;n.style.transition="none",n.style.transform="rotate(0deg)",n.offsetWidth;const r=Math.floor(401*Math.random())-200,d=s+r,a=4,l=.8,i=4,u=l+Math.abs(r)/200*(i-l);n.style.transition=`transform ${a}s cubic-bezier(0.42, 0, 0.58, 1)`,n.style.transform=`rotate(${d}deg)`,setTimeout((()=>{n.style.transition=`transform ${u}s ease-out`,n.style.transform=`rotate(${s}deg)`}),1e3*a);setTimeout((()=>{const e=n.querySelectorAll(".segment")[o];e&&e.classList.add("winning-segment");const t=document.getElementById(`wheel-btn-${selectedFortuneWheel.index}`);t&&t.remove(),spunBoxes.push(selectedFortuneWheel.userBoxId),fortuneWheels=fortuneWheels.filter((e=>e.userBoxId!==selectedFortuneWheel.userBoxId)),playSound("spinResultSound");const s=document.getElementById("fetchDataButton");s.disabled=!0,setTimeout((()=>{s.disabled=!1}),3e3),selectedFortuneWheel=null,document.getElementById("spinWheelButton").disabled=!0}),1e3*(a+u))}catch(n){alert("Error opening the box. Please try again."),console.error(n),e.disabled=!1}addTemporarySpinningClass()}function playSound(e){const n=document.getElementById(e);n&&(n.currentTime=0,n.play().catch((e=>console.warn("Sound playback error:",e))))}function addTemporarySpinningClass(){const e=document.getElementById("wheel");e&&setTimeout((()=>{e.classList.add("spining"),setTimeout((()=>{e.classList.remove("spining")}),3e3)}),500)}